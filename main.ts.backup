// ============================================
// ä¿ç½—ä¼ é“æ—…ç¨‹ - TypeScript æ¸¸æˆä¸»æ–‡ä»¶
// ============================================

// ============================================
// 1. ç±»å‹å®šä¹‰éƒ¨åˆ†
// ============================================

type ResourceChange = {
  faith?: number;
  stamina?: number;
  reputation?: number;
  churches?: number;
  disciples?: number;
  provision?: number;
  stability?: number;
  persecution?: number;
  morale?: number;
};

type ActionType = 'preach' | 'tentmaking' | 'disciple' | 'rest' | 'write_letter';

type CompanionTaskType = 'preach' | 'tentmaking' | 'heal' | 'teach' | 'defend' | 'visitation' | 'logistics' | 'assist_writing' | 'rest';

type SpecialtyType = 'preaching' | 'crafting' | 'healing' | 'teaching' | 'defense' | 'counselor' | 'resilient' | 'scribe';

interface Action {
  id: ActionType;
  name: string;
  nameChinese: string;
  description: string;
  cost: ResourceChange;
  effect: ResourceChange;
  minDisciples?: number;
  requiresCompanion?: boolean;
}

interface LetterEffect {
  cityId: string;
  effect: ResourceChange;
  description: string;
}

interface GameEvent {
  id: string;
  name: string;
  type: 'event' | 'decision';
  title?: string;
  description: string;
  text?: string;
  effect: ResourceChange;
  choices?: {
    label: string;
    description: string;
    effect: ResourceChange;
  }[];
}

interface DecisionEvent {
  id: string;
  name: string;
  type: 'decision';
  title?: string;
  description: string;
  text?: string;
  condition: (player: Player, city: City) => boolean;
  choices: {
    label: string;
    description: string;
    text: string;
    effect: ResourceChange;
    consequence: string;
  }[];
}

// ============================================
// 2. é…ç½®å¸¸é‡
// ============================================

const INITIAL_RESOURCES: ResourceChange = {
  faith: 100,
  stamina: 100,
  reputation: 50,
  churches: 0,
  disciples: 0,
  provision: 100,
  stability: 50,
  persecution: 0,
  morale: 80,
};

const CITY_CONFIG: Record<string, { name: string; nameChinese: string; difficulty: number; rounds: number; basePersecutionRate: number; maxTurns: number; description: string }> = {
  Antioch: {
    name: 'Antioch',
    nameChinese: 'å®‰æé˜¿',
    difficulty: 1,
    rounds: 4,
    basePersecutionRate: 5,
    maxTurns: 4,
    description: 'ä¿ç½—ä¼ é“æ—…ç¨‹çš„èµ·ç‚¹ï¼Œä¿¡å¾’ä¼—å¤šï¼Œæ•™å¯¼åŸºç¡€ç¨³å›º',
  },
  Philippi: {
    name: 'Philippi',
    nameChinese: 'è…“ç«‹æ¯”',
    difficulty: 2,
    rounds: 5,
    basePersecutionRate: 8,
    maxTurns: 5,
    description: 'é©¬å…¶é¡¿çš„é¦–åŸï¼Œç´«è‰²å¸ƒæ–™å•†äººä¹‹åœ°ï¼Œéœ€è¦é¢å¯¹æŒ‘æˆ˜',
  },
  Ephesus: {
    name: 'Ephesus',
    nameChinese: 'ä»¥å¼—æ‰€',
    difficulty: 3,
    rounds: 6,
    basePersecutionRate: 12,
    maxTurns: 6,
    description: 'äºšç»†äºšçš„å¤§éƒ½ä¼šï¼Œäºšåº•ç±³ç¥åº™æ‰€åœ¨åœ°ï¼Œå……æ»¡å±çµäº‰æˆ˜',
  },
};

const ACTIONS: Record<ActionType, Action> = {
  preach: {
    id: 'preach',
    name: 'Preach Gospel',
    nameChinese: 'ä¼ æ‰¬ç¦éŸ³',
    description: 'å‘åŸä¸­å±…æ°‘å®£è®²ç¦éŸ³ï¼Œå»ºç«‹æ•™ä¼šï¼Œå¢åŠ ä¿¡å¾’',
    cost: { stamina: 20, faith: 5 },
    effect: { reputation: 10, disciples: 2, persecution: 10 },
  },
  tentmaking: {
    id: 'tentmaking',
    name: 'Tentmaking',
    nameChinese: 'ç»‡å¸æ£š',
    description: 'åˆ¶ä½œå¸ç¯·ç»´ç”Ÿï¼Œæ¢å¤ä½“åŠ›ï¼Œç»´æŒåŸºæœ¬ç”Ÿæ´»',
    cost: { stamina: 10 },
    effect: { stamina: 15, faith: 5, provision: 10 },
  },
  disciple: {
    id: 'disciple',
    name: 'Train Disciples',
    nameChinese: 'è®­ç»ƒé—¨å¾’',
    description: 'æ·±å…¥æ•™å¯¼ä¿¡å¾’ï¼Œå»ºç«‹åšå›ºçš„é—¨å¾’ï¼Œå¢åŠ æ•™ä¼šæ ¹åŸº',
    cost: { stamina: 15, faith: 10 },
    effect: { disciples: 3, reputation: 5, stability: 10 },
    minDisciples: 2,
  },
  rest: {
    id: 'rest',
    name: 'Rest',
    nameChinese: 'å®‰æ­‡',
    description: 'ä¼‘æ¯ç¥·å‘Šï¼Œæ¢å¤ä½“åŠ›å’Œä¿¡å¿ƒ',
    cost: {},
    effect: { stamina: 30, faith: 15 },
  },
  write_letter: {
    id: 'write_letter',
    name: 'Write Epistle',
    nameChinese: 'æ’°å†™ä¹¦ä¿¡',
    description: 'ä¸ºå»ºç«‹çš„æ•™ä¼šæ’°å†™ä¹¦ä¿¡ï¼Œç•™ä¸‹å±çµé—äº§',
    cost: { stamina: 25, faith: 20 },
    effect: { reputation: 15 },
    requiresCompanion: true,
  },
};

const COMPANION_TASKS: Record<CompanionTaskType, { name: string; nameChinese: string; description: string; staminaCost: number; effect: ResourceChange }> = {
  preach: {
    name: 'Preach',
    nameChinese: 'å®£è®²',
    description: 'ååŠ©å®£è®²ç¦éŸ³',
    staminaCost: 15,
    effect: { reputation: 5 },
  },
  tentmaking: {
    name: 'Tentmaking',
    nameChinese: 'ç»‡å¸',
    description: 'ååŠ©åˆ¶ä½œå¸ç¯·',
    staminaCost: 10,
    effect: { stamina: 10, provision: 5 },
  },
  heal: {
    name: 'Heal',
    nameChinese: 'åŒ»æ²»',
    description: 'ä¸ºäººåŒ»ç—…',
    staminaCost: 20,
    effect: { reputation: 8, faith: 5 },
  },
  teach: {
    name: 'Teach',
    nameChinese: 'æ•™å¯¼',
    description: 'æ•™å¯¼ä¿¡å¾’',
    staminaCost: 15,
    effect: { disciples: 1, stability: 5 },
  },
  defend: {
    name: 'Defend',
    nameChinese: 'è¾©æŠ¤',
    description: 'ä¸ºä¿¡ä»°è¾©æŠ¤',
    staminaCost: 15,
    effect: { reputation: 3, persecution: -5 },
  },
  visitation: {
    name: 'Visitation',
    nameChinese: 'æ¢è®¿',
    description: 'æ¢è®¿ä¿¡å¾’ï¼Œå…³å¿ƒè½¯å¼±çš„å¼Ÿå…„',
    staminaCost: 12,
    effect: { stability: 8, morale: 5 },
  },
  logistics: {
    name: 'Logistics',
    nameChinese: 'åå‹¤',
    description: 'ç®¡ç†ç‰©èµ„å’Œåå‹¤',
    staminaCost: 10,
    effect: { provision: 10, stamina: 5 },
  },
  assist_writing: {
    name: 'Assist Writing',
    nameChinese: 'ååŠ©å†™ä½œ',
    description: 'ååŠ©æ’°å†™ä¹¦ä¿¡',
    staminaCost: 10,
    effect: { reputation: 3 },
  },
  rest: {
    name: 'Rest',
    nameChinese: 'ä¼‘æ¯',
    description: 'ä¼‘æ¯æ¢å¤ä½“åŠ›',
    staminaCost: 0,
    effect: { stamina: 20, morale: 5 },
  },
};

// ============================================
// 3. Companion ç±»ï¼ˆåŒå·¥ç³»ç»Ÿï¼‰
// ============================================

class Companion {
  id: string;
  name: string;
  nameChinese: string;
  stamina: number;
  maxStamina: number;
  morale: number;
  specialty: SpecialtyType;
  specialtyName: string;
  specialtyDescription: string;
  isActive: boolean;
  currentTask: CompanionTaskType | null;

  constructor(
    id: string,
    name: string,
    nameChinese: string,
    specialty: SpecialtyType,
    specialtyName: string,
    specialtyDescription: string
  ) {
    this.id = id;
    this.name = name;
    this.nameChinese = nameChinese;
    this.stamina = 100;
    this.maxStamina = 100;
    this.morale = 80;
    this.specialty = specialty;
    this.specialtyName = specialtyName;
    this.specialtyDescription = specialtyDescription;
    this.isActive = true;
    this.currentTask = null;
  }

  applySpecialtyEffect(action: ActionType): ResourceChange {
    let bonus: ResourceChange = {};
    
    switch (this.specialty) {
      case 'preaching':
        if (action === 'preach') {
          bonus = { reputation: 5, disciples: 1 };
        }
        break;
      case 'crafting':
        if (action === 'tentmaking') {
          bonus = { stamina: 10, provision: 5 };
        }
        break;
      case 'healing':
        if (action === 'preach' || action === 'disciple') {
          bonus = { faith: 8, reputation: 3 };
        }
        break;
      case 'teaching':
        if (action === 'disciple') {
          bonus = { disciples: 2, stability: 5 };
        }
        break;
      case 'defense':
        if (action === 'preach') {
          bonus = { reputation: 4, persecution: -3 };
        }
        break;
      case 'counselor':
        if (action === 'disciple' || action === 'rest') {
          bonus = { morale: 10, stability: 5 };
        }
        break;
      case 'resilient':
        if (action === 'preach') {
          bonus = { stamina: 5, persecution: -5 };
        }
        break;
      case 'scribe':
        if (action === 'write_letter') {
          bonus = { reputation: 10 };
        }
        break;
    }
    
    return bonus;
  }

  getEfficiency(): number {
    const staminaRatio = this.stamina / this.maxStamina;
    const moraleFactor = this.morale / 100;
    return (staminaRatio * 0.6 + moraleFactor * 0.4);
  }

  assignTask(task: CompanionTaskType): { success: boolean; message: string; effect: ResourceChange } {
    const taskInfo = COMPANION_TASKS[task];
    
    if (this.stamina < taskInfo.staminaCost) {
      return { success: false, message: `${this.nameChinese}ä½“åŠ›ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œ${taskInfo.nameChinese}ä»»åŠ¡`, effect: {} };
    }
    
    this.currentTask = task;
    this.stamina -= taskInfo.staminaCost;
    
    // ç‰¹æ®Šä¸“é•¿åŠ æˆ
    let bonusEffect: ResourceChange = {};
    if (this.specialty === 'teaching' && task === 'teach') {
      bonusEffect = { disciples: 1 };
    } else if (this.specialty === 'scribe' && task === 'assist_writing') {
      bonusEffect = { reputation: 5 };
    } else if (this.specialty === 'counselor' && task === 'visitation') {
      bonusEffect = { stability: 5, morale: 5 };
    }
    
    const finalEffect = { ...taskInfo.effect, ...bonusEffect };
    
    return { 
      success: true, 
      message: `${this.nameChinese}æˆåŠŸæ‰§è¡Œ${taskInfo.nameChinese}ä»»åŠ¡`, 
      effect: finalEffect 
    };
  }

  recoverStamina(): void {
    this.stamina = Math.min(this.stamina + 20, this.maxStamina);
  }

  getStatus(): string {
    const statusSymbol = this.isActive ? 'âœ…' : 'âŒ';
    return `${statusSymbol} ${this.nameChinese}(${this.name}) - ä½“åŠ›: ${this.stamina}/${this.maxStamina}, å£«æ°”: ${this.morale}%, ä¸“é•¿: ${this.specialtyName}`;
  }
}

// ============================================
// 4. LetterSystem ç±»ï¼ˆä¹¦ä¿¡ç³»ç»Ÿï¼‰
// ============================================

class LetterSystem {
  epistleCollection: Map<string, boolean>;
  cityLetterEffects: Map<string, LetterEffect[]>;
  letterScore: number;

  constructor() {
    this.epistleCollection = new Map();
    this.cityLetterEffects = new Map();
    this.letterScore = 0;
    this.initializeEpistles();
  }

  initializeEpistles(): void {
    // åŠ æ‹‰å¤ªä¹¦
    this.cityLetterEffects.set('galatians', [{
      cityId: 'galatia',
      effect: { faith: 20, reputation: 10, stability: 15 },
      description: 'åŠ æ‹‰å¤ªä¹¦ï¼šç»´æŠ¤å› ä¿¡ç§°ä¹‰çš„çœŸç†'
    }]);
    
    // è…“ç«‹æ¯”ä¹¦
    this.cityLetterEffects.set('philippians', [{
      cityId: 'philippi',
      effect: { faith: 25, reputation: 15, disciples: 2, stability: 10 },
      description: 'è…“ç«‹æ¯”ä¹¦ï¼šåœ¨æ‚£éš¾ä¸­å–œä¹ï¼Œè¿½æ±‚åŸºç£é‡Œçš„åˆä¸€'
    }]);
    
    // ä»¥å¼—æ‰€ä¹¦
    this.cityLetterEffects.set('ephesians', [{
      cityId: 'ephesus',
      effect: { faith: 30, reputation: 20, churches: 1, stability: 20 },
      description: 'ä»¥å¼—æ‰€ä¹¦ï¼šæ•™ä¼šçš„å¥¥ç§˜ï¼Œä¿¡å¾’åœ¨åŸºç£é‡Œçš„åœ°ä½'
    }]);
    
    // æ­Œç½—è¥¿ä¹¦
    this.cityLetterEffects.set('colossians', [{
      cityId: 'colossae',
      effect: { faith: 20, disciples: 2, stability: 15 },
      description: 'æ­Œç½—è¥¿ä¹¦ï¼šåŸºç£çš„è‡³é«˜æ— ä¸Š'
    }]);
    
    // è…“åˆ©é—¨ä¹¦
    this.cityLetterEffects.set('philemon', [{
      cityId: 'colossae',
      effect: { reputation: 15, faith: 10, stability: 5 },
      description: 'è…“åˆ©é—¨ä¹¦ï¼šå¼Ÿå…„ç›¸çˆ±ï¼Œé¥¶æ•ä¸æ¥çº³'
    }]);
  }

  canWriteLetter(cityId: string, player: Player): boolean {
    const cityConfig = CITY_CONFIG[cityId];
    if (!cityConfig) return false;
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨è¯¥åŸå¸‚å†™è¿‡ä¿¡
    if (this.epistleCollection.get(cityId)) return false;
    
    // æ£€æŸ¥é—¨å¾’æ•°é‡æ˜¯å¦è¶³å¤Ÿ
    if (player.disciples < 3) return false;
    
    // æ£€æŸ¥ä¿¡å¿ƒå€¼æ˜¯å¦è¶³å¤Ÿ
    if (player.faith < 30) return false;
    
    return true;
  }

  writeLetter(cityId: string, cityName: string): { success: boolean; message: string; effect?: ResourceChange } {
    if (this.epistleCollection.get(cityId)) {
      return { success: false, message: `å·²ç»åœ¨${cityName}å†™è¿‡ä¹¦ä¿¡äº†` };
    }
    
    this.epistleCollection.set(cityId, true);
    this.letterScore += 50;
    
    const effects = this.cityLetterEffects.get(cityId);
    const effect = effects ? effects[0].effect : { faith: 15, reputation: 10 };
    
    return {
      success: true,
      message: `æˆåŠŸæ’°å†™äº†è‡´${cityName}æ•™ä¼šçš„ä¹¦ä¿¡ï¼`,
      effect
    };
  }

  getCollectionStatus(): string {
    const letters: { city: string; collected: boolean }[] = [];
    let collected = 0;
    
    for (const [cityId, isCollected] of this.epistleCollection) {
      const cityConfig = CITY_CONFIG[cityId];
      const cityName = cityConfig ? cityConfig.nameChinese : cityId;
      letters.push({ city: cityName, collected: isCollected });
      if (isCollected) collected++;
    }
    
    // æ·»åŠ å¯ä»¥å†™çš„ä¹¦ä¿¡
    const possibleLetters = [
      { cityId: 'galatians', city: 'åŠ æ‹‰å¤ª' },
      { cityId: 'philippians', city: 'è…“ç«‹æ¯”' },
      { cityId: 'ephesians', city: 'ä»¥å¼—æ‰€' },
      { cityId: 'colossians', city: 'æ­Œç½—è¥¿' },
      { cityId: 'philemon', city: 'è…“åˆ©é—¨' },
    ];
    
    for (const letter of possibleLetters) {
      if (!this.epistleCollection.has(letter.cityId)) {
        letters.push({ city: letter.city, collected: false });
      }
    }
    
    let output = '\nğŸ“š ä¹¦ä¿¡æ”¶é›†è¿›åº¦:\n';
    output += `   å·²æ”¶é›†: ${collected}/${possibleLetters.length}\n`;
    for (const letter of letters) {
      const symbol = letter.collected ? 'âœ…' : 'â¬œ';
      output += `   ${symbol} ${letter.city}\n`;
    }
    
    return output;
  }

  applyLetterEffectsToCity(cityId: string): ResourceChange {
    const effects = this.cityLetterEffects.get(cityId);
    if (effects && this.epistleCollection.get(cityId)) {
      return effects[0].effect;
    }
    return {};
  }

  isCompleteCollection(): boolean {
    const possibleLetters = ['galatians', 'philippians', 'ephesians', 'colossians', 'philemon'];
    return possibleLetters.every(id => this.epistleCollection.get(id) === true);
  }
}

// ============================================
// 5. Player ç±»
// ============================================

class Player {
  faith: number;
  stamina: number;
  maxStamina: number;
  reputation: number;
  churches: number;
  disciples: number;
  provision: number;
  stability: number;
  persecution: number;
  morale: number;
  companions: Companion[];
  visitedCities: string[];
  currentCity: string | null;

  constructor() {
    this.faith = INITIAL_RESOURCES.faith || 100;
    this.stamina = INITIAL_RESOURCES.stamina || 100;
    this.maxStamina = 100;
    this.reputation = INITIAL_RESOURCES.reputation || 50;
    this.churches = INITIAL_RESOURCES.churches || 0;
    this.disciples = INITIAL_RESOURCES.disciples || 0;
    this.provision = INITIAL_RESOURCES.provision || 100;
    this.stability = INITIAL_RESOURCES.stability || 50;
    this.persecution = INITIAL_RESOURCES.persecution || 0;
    this.morale = INITIAL_RESOURCES.morale || 80;
    this.companions = [];
    this.visitedCities = [];
    this.currentCity = null;
  }

  addCompanion(companion: Companion): void {
    this.companions.push(companion);
  }

  removeCompanion(companionId: string): boolean {
    const index = this.companions.findIndex(c => c.id === companionId);
    if (index !== -1) {
      this.companions.splice(index, 1);
      return true;
    }
    return false;
  }

  getActiveCompanions(): Companion[] {
    return this.companions.filter(c => c.isActive);
  }

  consumeResources(cost: ResourceChange): boolean {
    if (cost.faith && this.faith < cost.faith) return false;
    if (cost.stamina && this.stamina < cost.stamina) return false;
    if (cost.reputation && this.reputation < cost.reputation) return false;
    if (cost.disciples && this.disciples < cost.disciples) return false;
    if (cost.provision && this.provision < cost.provision) return false;

    if (cost.faith) this.faith -= cost.faith;
    if (cost.stamina) this.stamina -= cost.stamina;
    if (cost.reputation) this.reputation -= cost.reputation;
    if (cost.disciples) this.disciples -= cost.disciples;
    if (cost.provision) this.provision -= cost.provision;

    return true;
  }

  applyEffects(effect: ResourceChange): void {
    if (effect.faith !== undefined) this.faith = Math.min(this.faith + effect.faith, 200);
    if (effect.stamina !== undefined) this.stamina = Math.min(this.stamina + effect.stamina, this.maxStamina);
    if (effect.reputation !== undefined) this.reputation = Math.min(this.reputation + effect.reputation, 200);
    if (effect.churches !== undefined) this.churches += effect.churches;
    if (effect.disciples !== undefined) this.disciples += effect.disciples;
    if (effect.provision !== undefined) this.provision = Math.min(this.provision + effect.provision, 150);
    if (effect.stability !== undefined) this.stability = Math.min(Math.max(this.stability + effect.stability, 0), 100);
    if (effect.persecution !== undefined) this.persecution = Math.min(Math.max(this.persecution + effect.persecution, 0), 100);
    if (effect.morale !== undefined) this.morale = Math.min(Math.max(this.morale + effect.morale, 0), 100);
  }

  rest(): void {
    this.stamina = Math.min(this.stamina + 30, this.maxStamina);
    this.faith = Math.min(this.faith + 15, 200);
    
    // æ¢å¤åŒå·¥ä½“åŠ›
    for (const companion of this.companions) {
      companion.recoverStamina();
    }
  }

  isAlive(): boolean {
    return this.stamina > 0 && this.provision > 0;
  }

  getStatus(): string {
    return `
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¿ç½—çš„çŠ¶æ€                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¿¡å¿ƒ (Faith):         ${this.faith.toString().padStart(3)}/200  â”‚
â”‚  ä½“åŠ› (Stamina):       ${this.stamina.toString().padStart(3)}/100  â”‚
â”‚  å£°æœ› (Reputation):    ${this.reputation.toString().padStart(3)}/200  â”‚
â”‚  æ•™ä¼š (Churches):      ${this.churches.toString().padStart(3)}      â”‚
â”‚  é—¨å¾’ (Disciples):     ${this.disciples.toString().padStart(3)}      â”‚
â”‚  ç‰©èµ„ (Provision):     ${this.provision.toString().padStart(3)}/150  â”‚
â”‚  ç¨³å®š (Stability):     ${this.stability.toString().padStart(3)}/100  â”‚
â”‚  é€¼è¿« (Persecution):   ${this.persecution.toString().padStart(3)}/100  â”‚
â”‚  å£«æ°” (Morale):        ${this.morale.toString().padStart(3)}/100  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`;
  }
}

// ============================================
// 6. City ç±»
// ============================================

class City {
  id: string;
  name: string;
  nameChinese: string;
  difficulty: number;
  maxTurns: number;
  currentTurn: number;
  description: string;
  isCompleted: boolean;
  letterWritten: boolean;
  disciplesGained: number;
  reputationGained: number;
  basePersecutionRate: number;

  constructor(cityId: string) {
    const config = CITY_CONFIG[cityId];
    if (!config) {
      throw new Error(`Unknown city: ${cityId}`);
    }
    
    this.id = cityId;
    this.name = config.name;
    this.nameChinese = config.nameChinese;
    this.difficulty = config.difficulty;
    this.maxTurns = config.maxTurns;
    this.currentTurn = 0;
    this.description = config.description;
    this.isCompleted = false;
    this.letterWritten = false;
    this.disciplesGained = 0;
    this.reputationGained = 0;
    this.basePersecutionRate = config.basePersecutionRate;
  }

  advanceTurn(): boolean {
    this.currentTurn++;
    if (this.currentTurn >= this.maxTurns) {
      this.isCompleted = true;
      return true;
    }
    return false;
  }

  getRemainingTurns(): number {
    return this.maxTurns - this.currentTurn;
  }

  getProgress(): number {
    return (this.currentTurn / this.maxTurns) * 100;
  }

  hasMoreRounds(): boolean {
    return this.currentTurn < this.maxTurns;
  }

  nextRound(): void {
    this.currentTurn++;
  }

  addDisciples(count: number): void {
    this.disciplesGained += count;
  }

  addReputation(amount: number): void {
    this.reputationGained += amount;
  }

  getRoundInfo(): string {
    return `${this.nameChinese}(${this.name}) - ç¬¬ ${this.currentTurn}/${this.maxTurns} å›åˆ`;
  }

  getSummary(): string {
    return `${this.nameChinese}(${this.name}) - å›åˆ: ${this.currentTurn}/${this.maxTurns}, è·å¾—é—¨å¾’: ${this.disciplesGained}, å£°æœ›: +${this.reputationGained}`;
  }
}

// ============================================
// 7. äº‹ä»¶åº“
// ============================================

const ANTIOCH_EVENTS: Record<string, GameEvent | DecisionEvent> = {
  christian_name: {
    id: 'christian_name',
    name: 'åŸºç£å¾’çš„ç§°å‘¼',
    type: 'event',
    description: 'é—¨å¾’ç§°ä¸ºåŸºç£å¾’æ˜¯ä»å®‰æé˜¿èµ·é¦–',
    text: 'åœ¨å®‰æé˜¿çš„æ•™ä¼šä¸­ï¼Œä¿¡å¾’ä»¬è¢«å¤–äººç§°ä¸º"åŸºç£å¾’"ï¼Œè¿™ä¸ªåå­—æˆä¸ºäº†ä¿¡ä»°çš„æ ‡å¿—ã€‚',
    effect: { reputation: 10, faith: 5 },
  },
  paul_barnabas_dispute: {
    id: 'paul_barnabas_dispute',
    name: 'ä¿ç½—ä¸å·´æ‹¿å·´çš„äº‰æ‰§',
    type: 'decision',
    description: 'å…³äºæ˜¯å¦å¸¦é©¬å¯åŒè¡Œçš„é—®é¢˜',
    text: 'å·´æ‹¿å·´æƒ³è¦å¸¦ç§°å‘¼é©¬å¯çš„çº¦ç¿°åŒå»ï¼Œä½†ä¿ç½—ä»¥ä¸ºä¸å¸¦ä»–åŒå»ä¸ºå®œï¼Œå› ä¸ºé©¬å¯ä»å‰åœ¨æ—éåˆ©äºšç¦»å¼€ä»–ä»¬ã€‚',
    choices: [
      { label: 'åšæŒå·±è§', description: 'ä¿ç½—è®¤ä¸ºé©¬å¯ä¸å¤Ÿå¿ å¿ƒï¼Œä¸èƒ½åŒè¡Œ', effect: { morale: -20, stability: -5 } },
      { label: 'è®©æ­¥', description: 'å°Šé‡å·´æ‹¿å·´çš„æ„è§ï¼Œå…è®¸é©¬å¯åŒè¡Œ', effect: { morale: 10, faith: 5 } },
    ],
  } as DecisionEvent,
  synagogue_dispute: {
    id: 'synagogue_dispute',
    name: 'ä¼šå ‚äº‰è®º',
    type: 'event',
    description: 'åœ¨ä¼šå ‚ä¸­ä¸äººè¾©è®º',
    text: 'æ¯é€¢å®‰æ¯æ—¥ï¼Œä½ ä»¬åœ¨ä¼šå ‚é‡Œä¸äººè¾©è®ºï¼ŒåŠåŒ–ä¼—äººã€‚',
    effect: { reputation: 5, persecution: 10 },
  },
  barnabas_encouragement: {
    id: 'barnabas_encouragement',
    name: 'å·´æ‹¿å·´çš„é¼“åŠ±',
    type: 'event',
    description: 'åŠæ…°å­å·´æ‹¿å·´çš„é¼“åŠ±',
    text: 'å·´æ‹¿å·´ç”¨ä¿¡å¿ƒå’Œé¼“åŠ±åšå›ºä¼—äººã€‚',
    effect: { morale: 15, faith: 10, provision: 10 },
  },
  gentile_inquiry: {
    id: 'gentile_inquiry',
    name: 'å¤–é‚¦äººçš„è¯¢é—®',
    type: 'decision',
    description: 'å¤–é‚¦äººæ¥è¯¢é—®æ•‘æ©ä¹‹é“',
    text: 'æœ‰å‡ ä¸ªå¤–é‚¦äººæ¥åˆ°ï¼Œè¦å¬ä¸»çš„é“ã€‚',
    choices: [
      { label: 'çƒ­æƒ…æ¥å¾…', description: 'å‘å¤–é‚¦äººä¼ è®²ç¦éŸ³', effect: { disciples: 2, reputation: 5 } },
      { label: 'è°¨æ…å¯¹å¾…', description: 'å…ˆè§‚å¯Ÿä»–ä»¬çš„åŠ¨æœº', effect: { faith: 5 } },
    ],
  } as DecisionEvent,
};

const PHILIPPI_EVENTS: Record<string, GameEvent | DecisionEvent> = {
  lydia_meeting: {
    id: 'lydia_meeting',
    name: 'é‡è§å•åº•äºš',
    type: 'event',
    description: 'å–ç´«è‰²å¸ƒåŒ¹çš„å¦‡äººå•åº•äºšä¿¡ä¸»',
    text: 'åœ¨æ²³è¾¹ç¥·å‘Šæ—¶ï¼Œä½ ä»¬é‡è§å–ç´«è‰²å¸ƒåŒ¹çš„å¦‡äººå•åº•äºšï¼Œå¥¹æ•å¼€å¿ƒé—¨æ¥å—äº†ç¦éŸ³ã€‚',
    effect: { disciples: 1, faith: 10, reputation: 5 },
  },
  sila_recruitment: {
    id: 'sila_recruitment',
    name: 'è¥¿æ‹‰åŠ å…¥',
    type: 'event',
    description: 'è¥¿æ‹‰æˆä¸ºåŒå·¥',
    text: 'è¥¿æ‹‰åŠ å…¥äº†ä½ ä»¬çš„å®£æ•™å›¢é˜Ÿï¼Œä»–æ˜¯ä¸€ä¸ªåšéŸ§çš„äººã€‚',
    effect: { morale: 10, stability: 5 },
  },
  python_spirit: {
    id: 'python_spirit',
    name: 'å·«é¬¼çš„åµåš·',
    type: 'decision',
    description: 'ä½¿å¥³è¢«å·«é¬¼æ‰€é™„',
    text: 'æœ‰ä¸€ä¸ªä½¿å¥³è¢«å·«é¬¼æ‰€é™„ï¼Œå¥¹è·Ÿéšä½ ä»¬å–Šå«è¯´ï¼š"è¿™äº›äººæ˜¯è‡³é«˜ç¥çš„ä»†äººã€‚"',
    choices: [
      { label: 'èµ¶å‡ºé¬¼å»', description: 'å¥‰è€¶ç¨£çš„åèµ¶å‡ºæ±¡é¬¼', effect: { reputation: 10, persecution: 20 } },
      { label: 'æš‚æ—¶å¿è€', description: 'æš‚æ—¶å¿è€å‡ å¤©ï¼Œå¯»æ‰¾åˆé€‚æ—¶æœº', effect: { stamina: -10 } },
    ],
  } as DecisionEvent,
  philippi_prison: {
    id: 'philippi_prison',
    name: 'è¢«å›šä¸åœ°éœ‡',
    type: 'event',
    description: 'è¢«æ‰“å¹¶è¢«æŠ•å…¥ç‹±ä¸­',
    text: 'å› èµ¶é¬¼å¼•èµ·éªšåŠ¨ï¼Œä¿ç½—å’Œè¥¿æ‹‰è¢«æ‰“å¹¶è¢«æŠ•å…¥ç‹±ä¸­ã€‚åŠå¤œåœ°å¤§éœ‡åŠ¨ï¼Œç‰¢é—¨å…¨å¼€ã€‚',
    effect: { persecution: -50, reputation: 20 },
  },
  midnight_praise: {
    id: 'midnight_praise',
    name: 'åŠå¤œå”±è¯—ç¥·å‘Š',
    type: 'event',
    description: 'åœ¨ç‹±ä¸­ç¥·å‘Šå”±è¯—èµç¾ç¥',
    text: 'çº¦åœ¨åŠå¤œï¼Œä¿ç½—å’Œè¥¿æ‹‰ç¥·å‘Šå”±è¯—èµç¾ç¥ï¼Œä¼—å›šçŠ¯ä¹Ÿä¾§è€³è€Œå¬ã€‚',
    effect: { stability: 20, reputation: 15, morale: 20 },
  },
};

const EPHESUS_EVENTS: Record<string, GameEvent | DecisionEvent> = {
  tyrannus_school: {
    id: 'tyrannus_school',
    name: 'æ¨å–‡å¥´å­¦æˆ¿',
    type: 'event',
    description: 'åœ¨æ¨å–‡å¥´å­¦æˆ¿è¾©è®º',
    text: 'ä½ ä»¬è¿›æ¨å–‡å¥´å­¦æˆ¿è¾©è®ºï¼Œå¦‚æ­¤æœ‰ä¸¤å¹´ä¹‹ä¹…ã€‚',
    effect: { disciples: 5, reputation: 10, stamina: -10 },
  },
  timothy_recruitment: {
    id: 'timothy_recruitment',
    name: 'ææ‘©å¤ªåŠ å…¥',
    type: 'event',
    description: 'ææ‘©å¤ªæˆä¸ºåŒå·¥',
    text: 'ææ‘©å¤ªåŠ å…¥äº†å›¢é˜Ÿï¼Œä»–æ˜¯ä¸€ä¸ªå¿ å¿ƒçš„ä»£ç¬”è€…ã€‚',
    effect: { morale: 15, stability: 5 },
  },
  sceva_sons: {
    id: 'sceva_sons',
    name: 'å£«åŸºç“¦çš„å„¿å­ä»¬',
    type: 'decision',
    description: 'æœ‰äººæ“…è‡ªå¥‰ä¿ç½—æ‰€ä¼ çš„è€¶ç¨£èµ¶é¬¼',
    text: 'æœ‰å‡ ä¸ªæ¸¸æ–¹èµ¶é¬¼çš„çŠ¹å¤ªäººï¼Œæ“…è‡ªå¥‰ä¿ç½—æ‰€ä¼ çš„è€¶ç¨£èµ¶é¬¼ï¼Œç»“æœæ¶é¬¼åè€Œåˆ¶æœäº†ä»–ä»¬ã€‚',
    choices: [
      { label: 'æ¾„æ¸…çœŸç†', description: 'å‘ä¼—äººè¯´æ˜çœŸé“', effect: { faith: 10, stability: 10 } },
      { label: 'ä¿æŒæ²‰é»˜', description: 'è®©äº‹ä»¶è‡ªç„¶å¹³æ¯', effect: { persecution: -5 } },
    ],
  } as DecisionEvent,
  burning_scrolls: {
    id: 'burning_scrolls',
    name: 'ç„šçƒ§é‚ªæœ¯ä¹¦å·',
    type: 'event',
    description: 'ä¿¡å¾’ç„šçƒ§é‚ªæœ¯ä¹¦å·',
    text: 'é‚£å·²ç»ä¿¡çš„äººï¼Œå¤šæœ‰æ¥æ‰¿è®¤è¯‰è¯´è‡ªå·±æ‰€è¡Œçš„äº‹ï¼Œç„šçƒ§é‚ªæœ¯ä¹¦å·ã€‚',
    effect: { faith: 20, stability: 15, reputation: 10 },
  },
  silversmith_riot: {
    id: 'silversmith_riot',
    name: 'é“¶åŒ æš´ä¹±',
    type: 'event',
    description: 'é“¶åŒ åº•ç±³ä¸¢èšé›†ä¼—äººåå¯¹',
    text: 'é“¶åŒ åº•ç±³ä¸¢èšé›†ä¼—äººåå¯¹ä¿ç½—ï¼Œè¯´ä¿ç½—æ…ä¹±äº†ä»¥å¼—æ‰€å…¨åŸã€‚',
    effect: { stamina: -20, provision: -10 },
  },
};

const LETTER_EVENTS: GameEvent[] = [
  {
    id: 'letter_galatians',
    name: 'åŠ æ‹‰å¤ªä¹¦çš„å¯ç¤º',
    type: 'event',
    description: 'ä½ æ„Ÿå—åˆ°åœ£çµçš„æ„ŸåŠ¨ï¼Œè¦ä¸ºåŠ æ‹‰å¤ªçš„æ•™ä¼šå†™ä¸€å°ä¿¡',
    text: 'è¦ä¸ºåŠ æ‹‰å¤ªçš„æ•™ä¼šå†™ä¿¡ï¼Œæ¾„æ¸…å› ä¿¡ç§°ä¹‰çš„çœŸç†ã€‚',
    effect: { faith: 20, reputation: 10 },
  },
  {
    id: 'letter_philippians',
    name: 'è…“ç«‹æ¯”ä¹¦çš„å–œä¹',
    type: 'event',
    description: 'æƒ³å¿µè…“ç«‹æ¯”æ•™ä¼šçš„åŒå·¥ä»¬',
    text: 'æƒ³å†™ä¿¡é¼“åŠ±ä»–ä»¬æ— è®ºåœ¨ä»€ä¹ˆæ™¯å†µéƒ½è¦å–œä¹ã€‚',
    effect: { faith: 15, reputation: 8 },
  },
  {
    id: 'letter_ephesians',
    name: 'ä»¥å¼—æ‰€ä¹¦çš„å¥¥ç§˜',
    type: 'event',
    description: 'ç¥å¯ç¤ºæ•™ä¼šçš„å¥¥ç§˜',
    text: 'ç¥å¯ç¤ºä½ æ•™ä¼šçš„å¥¥ç§˜â€”â€”å¤–é‚¦äººåœ¨åŸºç£è€¶ç¨£é‡Œï¼Œè—‰ç€ç¦éŸ³ï¼Œå¾—ä»¥åŒä¸ºåå—£ã€‚',
    effect: { faith: 25, reputation: 12 },
  },
];

// ============================================
// 8. GameEngine ç±»
// ============================================

class GameEngine {
  player: Player;
  currentCity: City | null;
  letterSystem: LetterSystem;
  gameLog: string[];
  isGameOver: boolean;
  isVictory: boolean;
  currentTurn: number;
  maxTurns: number;
  availableCities: string[];
  completedCities: string[];
  cities: City[];
  currentCityIndex: number;
  gameOver: boolean;
  victory: boolean;
  eventHistory: string[];
  tyrannusMode: boolean;
  companions: Companion[];
  companionLimit: number;
  totalFaithfulnessPoints: number;
  cityStabilityRecords: Map<string, number>;
  totalPersecutionReceived: number;
  totalStabilityLost: number;

  constructor() {
    this.player = new Player();
    this.currentCity = null;
    this.letterSystem = new LetterSystem();
    this.gameLog = [];
    this.isGameOver = false;
    this.isVictory = false;
    this.currentTurn = 0;
    this.maxTurns = 15;
    this.availableCities = ['Antioch', 'Philippi', 'Ephesus'];
    this.completedCities = [];
    this.cities = [];
    this.currentCityIndex = 0;
    this.gameOver = false;
    this.victory = false;
    this.eventHistory = [];
    this.tyrannusMode = false;
    this.companions = [];
    this.companionLimit = 2;
    this.totalFaithfulnessPoints = 0;
    this.cityStabilityRecords = new Map();
    this.totalPersecutionReceived = 0;
    this.totalStabilityLost = 0;
    
    // åˆå§‹åŒ–åŸå¸‚
    for (const cityId of this.availableCities) {
      this.cities.push(new City(cityId));
    }
    
    if (this.cities.length > 0) {
      this.currentCity = this.cities[0];
    }
  }

  initializeGame(): void {
    // åˆå§‹åŒ–åŒå·¥
    const barnabas = new Companion('barnabas', 'Barnabas', 'å·´æ‹¿å·´', 'counselor', 'åŠæ…°è€…', 'æå‡æ¢è®¿æ•ˆç‡å’Œå£«æ°”æ¢å¤');
    const silas = new Companion('silas', 'Silas', 'è¥¿æ‹‰', 'resilient', 'åšéŸ§è€…', 'é™ä½é€¼è¿«å¸¦æ¥çš„ä½“åŠ›æŸè€—');
    const timothy = new Companion('timothy', 'Timothy', 'ææ‘©å¤ª', 'scribe', 'å¿ å¿ƒä»£ç¬”è€…', 'ååŠ©æ’°å†™ä¹¦ä¿¡ï¼Œä½“åŠ›æ¶ˆè€—å‡åŠ');
    const luke = new Companion('luke', 'Luke', 'è·¯åŠ ', 'healing', 'åŒ»æ²»', 'æ“…é•¿åŒ»æ²»ç—…äºº');
    const priscilla = new Companion('priscilla', 'Priscilla', 'ç™¾åŸºæ‹‰', 'crafting', 'ç»‡é€ ', 'æ“…é•¿ç»‡é€ å¸ç¯·');
    
    this.player.addCompanion(barnabas);
    this.companions.push(barnabas);
    
    this.addToLog('æ¸¸æˆå¼€å§‹ï¼ä¿ç½—çš„å®£æ•™ä¹‹æ—…æ­£å¼å¯ç¨‹ã€‚');
    this.addToLog('ä½ çš„åŒå·¥å›¢é˜Ÿï¼šå·´æ‹¿å·´ï¼ˆåˆå§‹ï¼‰');
    this.addToLog('å…¶ä»–åŒå·¥å°†åœ¨åç»­åŸå¸‚åŠ å…¥ã€‚');
  }

  addCompanion(companion: Companion): boolean {
    if (this.companions.length >= this.companionLimit) {
      return false;
    }
    this.companions.push(companion);
    this.player.addCompanion(companion);
    return true;
  }

  getActiveCompanions(): Companion[] {
    return this.companions.filter(c => c.morale >= 20 && c.stamina > 0);
  }

  hasScribeCompanion(): boolean {
    return this.companions.some(c => c.specialty === 'scribe' && c.morale >= 20);
  }

  startCity(cityId: string): boolean {
    if (!this.availableCities.includes(cityId)) {
      return false;
    }
    
    this.currentCity = new City(cityId);
    this.player.currentCity = cityId;
    
    if (!this.player.visitedCities.includes(cityId)) {
      this.player.visitedCities.push(cityId);
    }
    
    this.addToLog(`æŠµè¾¾${this.currentCity.nameChinese}(${this.currentCity.name})`);
    this.addToLog(this.currentCity.description);
    
    // è§¦å‘åŸå¸‚äº‹ä»¶
    this.triggerCityEvent(cityId);
    
    return true;
  }

  triggerCityEvent(cityId: string): void {
    let events: (GameEvent | DecisionEvent)[] = [];
    
    switch (cityId) {
      case 'Antioch':
        events = Object.values(ANTIOCH_EVENTS);
        break;
      case 'Philippi':
        events = Object.values(PHILIPPI_EVENTS);
        break;
      case 'Ephesus':
        events = Object.values(EPHESUS_EVENTS);
        break;
    }
    
    if (events.length > 0) {
      const randomEvent = events[Math.floor(Math.random() * events.length)];
      if (randomEvent.type === 'event') {
        const event = randomEvent as GameEvent;
        this.addToLog(`ã€äº‹ä»¶ã€‘${event.name}: ${event.description}`);
        
        // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹
        this.player.applyEffects(event.effect);
        this.addToLog(`å½±å“: ${JSON.stringify(event.effect)}`);
      }
    }
  }

  performAction(actionType: ActionType): { success: boolean; message: string } {
    if (!this.currentCity) {
      return { success: false, message: 'æ²¡æœ‰å½“å‰åŸå¸‚' };
    }
    
    if (this.isGameOver) {
      return { success: false, message: 'æ¸¸æˆå·²ç»“æŸ' };
    }
    
    const action = ACTIONS[actionType];
    
    // æ£€æŸ¥èµ„æº
    if (!this.player.consumeResources(action.cost)) {
      return { success: false, message: 'èµ„æºä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ­¤è¡ŒåŠ¨' };
    }
    
    // åº”ç”¨è¡ŒåŠ¨æ•ˆæœ
    this.player.applyEffects(action.effect);
    
    // åº”ç”¨åŒå·¥åŠ æˆ
    for (const companion of this.player.getActiveCompanions()) {
      const bonus = companion.applySpecialtyEffect(actionType);
      this.player.applyEffects(bonus);
    }
    
    // æ›´æ–°åŸå¸‚çŠ¶æ€
    if (action.effect.disciples) {
      this.currentCity.addDisciples(action.effect.disciples);
    }
    if (action.effect.reputation) {
      this.currentCity.addReputation(action.effect.reputation);
    }
    
    // æ¨è¿›å›åˆ
    this.currentTurn++;
    const cityCompleted = this.currentCity.advanceTurn();
    
    this.addToLog(`æ‰§è¡Œè¡ŒåŠ¨: ${action.nameChinese} - ${action.description}`);
    
    if (cityCompleted) {
      this.completeCurrentCity();
    }
    
    // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
    this.checkGameEnd();
    
    return { success: true, message: `æˆåŠŸæ‰§è¡Œ${action.nameChinese}` };
  }

  handleAction(actionType: ActionType, companionActions?: Map<string, CompanionTaskType>): string {
    if (this.isGameOver) {
      return 'æ¸¸æˆå·²ç»“æŸã€‚';
    }

    const action = ACTIONS[actionType];
    
    if (!this.canPerformAction(action)) {
      return `èµ„æºä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œã€Œ${action.name}ã€`;
    }

    // è®°å½•å¿ å¿ƒç‚¹æ•°
    if (actionType === 'preach' && this.player.persecution > 70) {
      this.totalFaithfulnessPoints += 10;
    }

    const prevStability = this.player.stability;
    
    // å¤„ç†åŒå·¥ä»»åŠ¡
    let companionResults: string[] = [];
    if (companionActions) {
      for (const [companionId, taskType] of companionActions) {
        const companion = this.companions.find(c => c.id === companionId);
        if (companion) {
          const result = companion.assignTask(taskType);
          if (result.success) {
            this.player.applyEffects(result.effect);
            companionResults.push(`âœ… ${result.message}`);
          } else {
            companionResults.push(`âŒ ${result.message}`);
          }
        }
      }
    }

    // åº”ç”¨ä¿ç½—çš„è¡ŒåŠ¨æ•ˆæœ
    this.player.applyEffects(action.effect);
    
    // å›åˆæ¨è¿›
    this.currentCity?.nextRound();
    
    // å›åˆç»“æŸç»“ç®—
    this.endOfRoundSettlement();
    
    // è¿½è¸ªæ•™ä¼šå¥åº·åº¦å˜åŒ–
    const stabilityLoss = prevStability - this.player.stability;
    if (stabilityLoss > 0) {
      this.totalStabilityLost += stabilityLoss;
    }
    
    // æ¢å¤åŒå·¥ä½“åŠ›
    this.companions.forEach(c => c.recoverStamina());
    
    if (this.currentCity && !this.currentCity.hasMoreRounds()) {
      this.moveToNextCity();
    }
    
    // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
    this.checkGameEnd();

    return this.generateActionResult(action, companionResults);
  }

  private canPerformAction(action: Action): boolean {
    const effect = action.effect;
    if (effect.stamina && effect.stamina < 0 && this.player.stamina < Math.abs(effect.stamina)) {
      return false;
    }
    if (effect.provision && effect.provision < 0 && this.player.provision < Math.abs(effect.provision)) {
      return false;
    }
    return true;
  }

  private endOfRoundSettlement(): void {
    if (this.currentCity) {
      // è¿½è¸ªç´¯è®¡é€¼è¿«å€¼
      this.totalPersecutionReceived += this.currentCity.basePersecutionRate;
      
      // åŸå¸‚å›ºæœ‰çš„é€¼è¿«å¢é•¿
      this.player.applyEffects({
        persecution: this.currentCity.basePersecutionRate,
      });
      
      // ä»¥å¼—æ‰€ç‰¹æ®Šæœºåˆ¶
      if (this.currentCity.name === 'Ephesus' && this.tyrannusMode) {
        this.player.applyEffects({ stamina: -10 });
      }
    }
    
    this.checkCrisisEvents();
  }

  private checkCrisisEvents(): void {
    // æš´åŠ¨äº‹ä»¶
    if (this.player.persecution > 70) {
      console.log('\nâš ï¸  ã€æš´åŠ¨äº‹ä»¶ã€‘é€¼è¿«å¤ªç”šï¼Œä¼šå ‚ä¸­æœ‰äººèµ·æ¥åå¯¹ï¼');
      this.player.applyEffects({ stamina: -15, stability: -10 });
    }

    // åˆ†è£‚é£é™©
    if (this.player.stability < 30) {
      console.log('\nâš ï¸  ã€åˆ†è£‚é£é™©ã€‘ä¿¡å¾’ä¹‹é—´äº§ç”Ÿäº‰è®ºï¼Œéœ€è¦æ›´å¤šå…³æ€€ï¼');
      this.player.applyEffects({ stability: -5 });
    }

    if (!this.player.isAlive()) {
      this.gameOver = true;
      this.victory = false;
    }
  }

  private moveToNextCity(): void {
    if (!this.currentCity) return;
    
    console.log(`\nğŸ‰ å®Œæˆ ${this.currentCity.nameChinese} çš„å®£æ•™å·¥ä½œï¼å‡†å¤‡å‰å¾€ä¸‹ä¸€åŸ...\n`);
    
    // è®°å½•å½“å‰åŸå¸‚çš„æ•™ä¼šå¥åº·åº¦
    this.cityStabilityRecords.set(this.currentCity.name, this.player.stability);
    
    // ç¦»å¼€ä»¥å¼—æ‰€æ—¶é‡ç½®æ¨å–‡å¥´å­¦æˆ¿æ¨¡å¼
    if (this.currentCity.name === 'Ephesus') {
      this.tyrannusMode = false;
    }
    
    this.currentCityIndex++;
    
    if (this.currentCityIndex >= this.cities.length) {
      this.gameOver = true;
      this.victory = true;
    } else {
      this.currentCity = this.cities[this.currentCityIndex];
      
      // æ‹›å‹Ÿæ–°åŒå·¥
      this.recruitCompanionForCity();
    }
  }

  private recruitCompanionForCity(): void {
    if (!this.currentCity) return;
    
    if (this.currentCity.name === 'Philippi' && !this.companions.some(c => c.id === 'silas')) {
      const silas = new Companion(
        'silas',
        'Silas',
        'è¥¿æ‹‰',
        'resilient',
        'åšéŸ§è€…',
        'é™ä½é€¼è¿«å¸¦æ¥çš„ä½“åŠ›æŸè€—ï¼Œå¢å¼ºæ•™å¯¼èƒ½åŠ›'
      );
      if (this.addCompanion(silas)) {
        console.log(`\nğŸ‘¥ ã€åŒå·¥åŠ å…¥ã€‘${silas.nameChinese}åŠ å…¥äº†å›¢é˜Ÿï¼`);
        console.log(`   ç‰¹æ€§ï¼š${silas.specialtyName} - ${silas.specialtyDescription}`);
      }
    }
    
    if (this.currentCity.name === 'Ephesus' && !this.companions.some(c => c.id === 'timothy')) {
      const timothy = new Companion(
        'timothy',
        'Timothy',
        'ææ‘©å¤ª',
        'scribe',
        'å¿ å¿ƒä»£ç¬”è€…',
        'ååŠ©æ’°å†™ä¹¦ä¿¡ï¼Œä½“åŠ›æ¶ˆè€—å‡åŠ'
      );
      if (this.addCompanion(timothy)) {
        console.log(`\nğŸ‘¥ ã€åŒå·¥åŠ å…¥ã€‘${timothy.nameChinese}åŠ å…¥äº†å›¢é˜Ÿï¼`);
        console.log(`   ç‰¹æ€§ï¼š${timothy.specialtyName} - ${timothy.specialtyDescription}`);
      }
    }
  }

  private generateActionResult(action: Action, companionResults: string[]): string {
    let result = `\nâœ… æ‰§è¡Œã€Œ${action.name}ã€`;
    if (companionResults.length > 0) {
      result += '\n' + companionResults.join('\n');
    }
    result += `\n${this.player.getStatus()}`;
    if (this.currentCity) {
      result += `\nğŸ“ å½“å‰ä½ç½®: ${this.currentCity.getRoundInfo()}`;
    }
    return result;
  }

  writeLetter(): { success: boolean; message: string } {
    if (!this.currentCity) {
      return { success: false, message: 'æ²¡æœ‰å½“å‰åŸå¸‚' };
    }
    
    if (!this.letterSystem.canWriteLetter(this.currentCity.id, this.player)) {
      return { success: false, message: 'æ¡ä»¶ä¸æ»¡è¶³ï¼ˆéœ€è¦è‡³å°‘3åé—¨å¾’å’Œ30ä¿¡å¿ƒå€¼ï¼‰' };
    }
    
    const result = this.letterSystem.writeLetter(this.currentCity.id, this.currentCity.nameChinese);
    
    if (result.success) {
      this.player.applyEffects(result.effect || {});
      this.currentCity.letterWritten = true;
      this.addToLog(result.message);
    }
    
    return result;
  }

  completeCurrentCity(): void {
    if (!this.currentCity) return;
    
    this.completedCities.push(this.currentCity.id);
    this.addToLog(`å®Œæˆ${this.currentCity.nameChinese}çš„äº‹å·¥ï¼`);
    
    // å¥–åŠ±
    const bonus: ResourceChange = {
      faith: 20,
      reputation: 10,
    };
    
    if (this.currentCity.disciplesGained >= 5) {
      bonus.churches = 1;
      this.addToLog('å»ºç«‹äº†æ–°çš„æ•™ä¼šï¼');
    }
    
    this.player.applyEffects(bonus);
  }

  moveToNextCityManual(): boolean {
    if (this.completedCities.length >= this.availableCities.length) {
      this.isGameOver = true;
      this.isVictory = true;
      return false;
    }
    
    // æ‰¾åˆ°ä¸‹ä¸€ä¸ªæœªè®¿é—®çš„åŸå¸‚
    for (const cityId of this.availableCities) {
      if (!this.completedCities.includes(cityId)) {
        this.startCity(cityId);
        return true;
      }
    }
    
    return false;
  }

  checkGameEnd(): void {
    // æ£€æŸ¥èƒœåˆ©æ¡ä»¶
    if (this.completedCities.length >= 3 && this.letterSystem.isCompleteCollection()) {
      this.isGameOver = true;
      this.isVictory = true;
      this.addToLog('æ­å–œï¼ä½ å®Œæˆäº†ä¿ç½—çš„ä¸‰æ¬¡å®£æ•™æ—…ç¨‹å¹¶æ”¶é›†äº†æ‰€æœ‰ä¹¦ä¿¡ï¼');
      return;
    }
    
    // æ£€æŸ¥å¤±è´¥æ¡ä»¶
    if (this.player.faith <= 0) {
      this.isGameOver = true;
      this.isVictory = false;
      this.addToLog('æ¸¸æˆç»“æŸï¼šä¿¡å¿ƒè€—å°½...');
      return;
    }
    
    if (this.player.stamina <= 0) {
      this.isGameOver = true;
      this.isVictory = false;
      this.addToLog('æ¸¸æˆç»“æŸï¼šä½“åŠ›è€—å°½...');
      return;
    }
    
    if (this.currentTurn >= this.maxTurns) {
      this.isGameOver = true;
      this.isVictory = this.completedCities.length >= 2;
      this.addToLog(this.isVictory ? 'æ—¶é—´åˆ°ï¼Œä½†ä½ å®Œæˆäº†ä¸»è¦ç›®æ ‡ï¼' : 'æ—¶é—´åˆ°ï¼Œæœªèƒ½å®Œæˆä¸»è¦ç›®æ ‡...');
    }
  }

  assignCompanionTask(companionId: string, task: CompanionTaskType): { success: boolean; message: string } {
    const companion = this.player.companions.find(c => c.id === companionId);
    if (!companion) {
      return { success: false, message: 'æ‰¾ä¸åˆ°è¯¥åŒå·¥' };
    }
    
    if (!companion.isActive) {
      return { success: false, message: 'è¯¥åŒå·¥å½“å‰ä¸æ´»è·ƒ' };
    }
    
    const result = companion.assignTask(task);
    if (result.success) {
      const taskInfo = COMPANION_TASKS[task];
      this.player.applyEffects(result.effect);
      this.addToLog(`${companion.nameChinese}æ‰§è¡Œ${taskInfo.nameChinese}ä»»åŠ¡: ${taskInfo.description}`);
      return { success: true, message: `æˆåŠŸåˆ†é…ä»»åŠ¡` };
    }
    
    return { success: false, message: result.message };
  }

  triggerEvent(): { event: GameEvent | DecisionEvent | null; message: string } {
    // å®‰æé˜¿äº‹ä»¶æµ
    if (this.currentCity?.name === 'Antioch') {
      if (this.currentCity.currentTurn === 2 && !this.eventHistory.includes('christian_name')) {
        return this.executeEvent(ANTIOCH_EVENTS['christian_name'] as GameEvent);
      }
      
      if (this.player.provision < 20 && this.currentCity.currentTurn >= 3 && 
          !this.eventHistory.includes('paul_barnabas_dispute')) {
        return { event: ANTIOCH_EVENTS['paul_barnabas_dispute'], message: '' };
      }
    }
    
    // è…“ç«‹æ¯”äº‹ä»¶æµ
    if (this.currentCity?.name === 'Philippi') {
      if (this.currentCity.currentTurn === 1 && !this.eventHistory.includes('lydia_meeting')) {
        return this.executeEvent(PHILIPPI_EVENTS['lydia_meeting'] as GameEvent);
      }
    }
    
    return { event: null, message: '' };
  }

  private executeEvent(event: GameEvent): { event: GameEvent | DecisionEvent | null; message: string } {
    if (event.type === 'decision') {
      return { event, message: '' };
    }
    
    this.eventHistory.push(event.id);
    this.player.applyEffects(event.effect);
    
    let message = '\n' + '='.repeat(50);
    message += `\nğŸ“œ ã€${event.name}ã€‘${event.description}`;
    message += '\n' + '-'.repeat(50);
    message += `\n${event.text}`;
    message += '\n' + '-'.repeat(50);
    
    const changes: string[] = [];
    if (event.effect.stability) changes.push(`æ•™ä¼šå¥åº· ${event.effect.stability > 0 ? '+' : ''}${event.effect.stability}`);
    if (event.effect.persecution) changes.push(`é€¼è¿«æŒ‡æ•° ${event.effect.persecution > 0 ? '+' : ''}${event.effect.persecution}`);
    if (event.effect.stamina) changes.push(`ä½“åŠ› ${event.effect.stamina > 0 ? '+' : ''}${event.effect.stamina}`);
    if (event.effect.provision) changes.push(`ç‰©èµ„ ${event.effect.provision > 0 ? '+' : ''}${event.effect.provision}`);
    if (event.effect.reputation) changes.push(`åå£° ${event.effect.reputation > 0 ? '+' : ''}${event.effect.reputation}`);
    if (event.effect.morale) changes.push(`åŒå·¥å£«æ°” ${event.effect.morale > 0 ? '+' : ''}${event.effect.morale}`);
    
    if (changes.length > 0) {
      message += `\nğŸ“Š å½±å“ï¼š${changes.join('ï¼Œ ')}`;
    }
    message += '\n' + '='.repeat(50);
    
    return { event, message };
  }

  handleDecision(eventId: string, choiceIndex: number): string {
    const event = (ANTIOCH_EVENTS[eventId] || PHILIPPI_EVENTS[eventId] || EPHESUS_EVENTS[eventId]) as DecisionEvent;
    if (!event || event.type !== 'decision') {
      return 'æ— æ•ˆçš„äº‹ä»¶æˆ–å†³ç­–';
    }
    
    if (choiceIndex < 0 || choiceIndex >= event.choices.length) {
      return 'æ— æ•ˆçš„é€‰æ‹©';
    }
    
    this.eventHistory.push(eventId);
    const choice = event.choices[choiceIndex];
    this.player.applyEffects(choice.effect);
    
    // å¤„ç†åŒå·¥äº‰æ‰§çš„ç‰¹æ®Šæ•ˆæœ
    if (eventId === 'paul_barnabas_dispute') {
      if (choiceIndex === 0) {
        // å·´æ‹¿å·´å¸¦ç€é©¬å¯ç¦»å¼€
        const barnabas = this.companions.find(c => c.id === 'barnabas');
        if (barnabas) {
          barnabas.isActive = false;
          console.log('\nğŸ’” å·´æ‹¿å·´å¸¦ç€é©¬å¯å‰å¾€å¡æµ¦è·¯æ–¯...');
        }
      }
    }
    
    let message = '\n' + '='.repeat(50);
    message += `\nğŸ“œ ã€${event.name}ã€‘${event.description}`;
    message += '\n' + '-'.repeat(50);
    message += `\n${event.text}`;
    message += '\n' + '-'.repeat(50);
    message += `\nâœ… ä½ é€‰æ‹©ï¼š${choice.label}`;
    message += `\n   ${choice.description}`;
    
    const changes: string[] = [];
    if (choice.effect.stability) changes.push(`æ•™ä¼šå¥åº· ${choice.effect.stability > 0 ? '+' : ''}${choice.effect.stability}`);
    if (choice.effect.persecution) changes.push(`é€¼è¿«æŒ‡æ•° ${choice.effect.persecution > 0 ? '+' : ''}${choice.effect.persecution}`);
    if (choice.effect.stamina) changes.push(`ä½“åŠ› ${choice.effect.stamina > 0 ? '+' : ''}${choice.effect.stamina}`);
    if (choice.effect.provision) changes.push(`ç‰©èµ„ ${choice.effect.provision > 0 ? '+' : ''}${choice.effect.provision}`);
    if (choice.effect.morale) changes.push(`åŒå·¥å£«æ°” ${choice.effect.morale > 0 ? '+' : ''}${choice.effect.morale}`);
    
    if (changes.length > 0) {
      message += `\nğŸ“Š å½±å“ï¼š${changes.join('ï¼Œ ')}`;
    }
    message += '\n' + '='.repeat(50);
    
    return message;
  }

  calculateFinalScore(): {
    totalScore: number;
    churchMaturity: number;
    resilience: number;
    stewardship: number;
    faithfulness: number;
    letterBonus: number;
    verdict: string;
    description: string;
  } {
    if (this.currentCity && !this.cityStabilityRecords.has(this.currentCity.name)) {
      this.cityStabilityRecords.set(this.currentCity.name, this.player.stability);
    }
    
    let totalStability = 0;
    let cityCount = 0;
    this.cityStabilityRecords.forEach((stability) => {
      totalStability += stability;
      cityCount++;
    });
    if (cityCount < this.cities.length) {
      totalStability += this.player.stability;
      cityCount++;
    }
    const churchMaturity = cityCount > 0 ? (totalStability / cityCount) : 0;
    
    let resilience = 100;
    if (this.totalStabilityLost > 0) {
      resilience = Math.max(0, 100 - (this.totalStabilityLost / this.totalPersecutionReceived) * 100);
    }
    
    const staminaRatio = this.player.stamina / 100;
    const provisionRatio = this.player.provision / 150;
    const stewardship = ((staminaRatio + provisionRatio) / 2) * 100;
    
    const faithfulness = Math.min(100, 50 + this.totalFaithfulnessPoints);
    
    // ä¹¦ä¿¡åŠ æˆ
    const letterBonus = this.letterSystem.letterScore / 10;
    
    const totalScore = 
      (churchMaturity * 0.35) +
      (resilience * 0.15) +
      (stewardship * 0.15) +
      (faithfulness * 0.20) +
      (Math.min(letterBonus, 15));
    
    // å®Œæ•´ä¹¦ä¿¡é›†éšè—åŠ æˆ
    const collectionComplete = this.letterSystem.isCompleteCollection();
    const finalScore = collectionComplete ? Math.min(100, totalScore + 5) : totalScore;
    
    let verdict: string;
    let description: string;
    
    if (finalScore >= 90) {
      verdict = 'ã€è‡³æ­»å¿ å¿ƒçš„ä½¿å¾’ã€‘';
      description = collectionComplete 
        ? '"ä½ åˆ°è¾¾äº†ç½—é©¬ï¼Œèº«ä¸Šå¸¦ç€åŸºç£çš„å°è®°ã€‚ä½ åœ¨äºšç»†äºšå’Œæ¬§æ´²å»ºç«‹çš„æ•™ä¼šç¨³å›ºå¦‚ç£çŸ³ï¼ŒåŒå·¥ä»¬è§†ä½ ä¸ºæ¦œæ ·ã€‚æ–°çº¦ä¹¦ä¿¡åœ¨ä½ æ‰‹ä¸­å®Œæˆï¼Œæˆä¸ºåä¸–ä¿¡å¾’æ°¸æ’çš„æŒ‡å—ã€‚ä½ æ‰“è¿‡äº†é‚£ç¾å¥½çš„ä»—ã€‚"'
        : '"ä½ åˆ°è¾¾äº†ç½—é©¬ï¼Œèº«ä¸Šå¸¦ç€åŸºç£çš„å°è®°ã€‚ä½ åœ¨äºšç»†äºšå’Œæ¬§æ´²å»ºç«‹çš„æ•™ä¼šç¨³å›ºå¦‚ç£çŸ³ï¼ŒåŒå·¥ä»¬è§†ä½ ä¸ºæ¦œæ ·ã€‚ä½ æ‰“è¿‡äº†é‚£ç¾å¥½çš„ä»—ã€‚"';
    } else if (finalScore >= 70) {
      verdict = 'ã€åŠ³è‹¦çš„ç¦éŸ³å…ˆé”‹ã€‘';
      description = '"å°½ç®¡è·¯é€”è‰°è¾›ï¼Œèº«ä½“è¡°å¼±ï¼Œä½†ä½ æˆåŠŸåœ°åœ¨å…³é”®åŸå¸‚æ‰ä¸‹äº†çœŸç†çš„æ ¹ã€‚ä¹¦ä¿¡æˆä¸ºäº†ä½ ç•™ç»™åä¸–æœ€å®è´µçš„è´¢å¯Œã€‚"';
    } else if (finalScore >= 40) {
      verdict = 'ã€ç–²æƒ«çš„å®ˆæœ›è€…ã€‘';
      description = '"ä½ åˆ°è¾¾äº†ç½—é©¬ï¼Œä½†å¿ƒä¸­å……æ»¡äº†å¿§è™‘ã€‚éƒ¨åˆ†åŸå¸‚çš„æ•™ä¼šå› ç¼ºä¹æ•™å¯¼è€ŒåŠ¨æ‘‡ã€‚ä½ å°½åŠ›äº†ï¼Œä½†èµ„æºåŒ®ä¹è®©ä½ æ­¥å±¥ç»´è‰°ã€‚"';
    } else {
      verdict = 'ã€è¢«å›´å›°çš„ç‹¬è¡Œè€…ã€‘';
      description = '"ä½ å‡ ä¹æ˜¯å­¤èº«ä¸€äººåˆ°è¾¾ç½—é©¬ã€‚è™½ç„¶å®Œæˆäº†æ—…ç¨‹ï¼Œä½†èº«åçš„æ•™ä¼šç½‘ç»œæ”¯ç¦»ç ´ç¢ã€‚è¿™è¶Ÿæ—…ç¨‹å¯¹ä½ è€Œè¨€æ˜¯ä¸€åœºæƒ¨çƒˆçš„ç”Ÿè¿˜ã€‚"';
    }
    
    return {
      totalScore: Math.round(finalScore),
      churchMaturity: Math.round(churchMaturity),
      resilience: Math.round(resilience),
      stewardship: Math.round(stewardship),
      faithfulness: Math.round(faithfulness),
      letterBonus: Math.round(letterBonus),
      verdict,
      description,
    };
  }

  displayEvaluation(): string {
    const score = this.calculateFinalScore();
    
    let output = '\n' + '='.repeat(60);
    output += '\n' + ' '.repeat(15) + 'ğŸ“Š ä½¿å‘½å¿ å¿ƒåº¦è¯„ä¼° ğŸ“Š';
    output += '\n' + '='.repeat(60);
    output += '\n';
    output += '\nğŸ“ˆ è¯¦ç»†è¯„åˆ†ï¼š';
    output += `\n   æ•™ä¼šæˆç†Ÿåº¦ (35%): ${score.churchMaturity}/100`;
    output += `\n   ä½¿å‘½éŸ§æ€§   (15%): ${score.resilience}/100`;
    output += `\n   èµ„æºç®¡å®¶   (15%): ${score.stewardship}/100`;
    output += `\n   å¿ å¿ƒæŒ‡æ•°   (20%): ${score.faithfulness}/100`;
    output += `\n   ä¹¦ä¿¡è´¡çŒ®   (+15): ${score.letterBonus}/15`;
    output += '\n' + '-'.repeat(60);
    output += `\nğŸ“Š æ€»åˆ†: ${score.totalScore}/100`;
    if (this.letterSystem.isCompleteCollection()) {
      output += '\nğŸ† ã€éšè—æˆå°±ã€‘å®Œæˆæ–°çº¦ä¹¦ä¿¡å…¨é›†ï¼';
    }
    output += '\n' + '='.repeat(60);
    output += `\nğŸ† ${score.verdict}`;
    output += '\n' + '-'.repeat(60);
    output += `\n${score.description}`;
    output += '\n' + '='.repeat(60);
    
    return output;
  }

  getGameStateDisplay(): string {
    if (this.gameOver) {
      if (this.victory) {
        return '\nğŸ† ã€æ¸¸æˆç»“æŸã€‘ä½ å®Œæˆäº†æ‰€æœ‰åŸå¸‚çš„å®£æ•™ä½¿å‘½ï¼"é‚£ç¾å¥½çš„ä»—æˆ‘å·²ç»æ‰“è¿‡äº†..."';
      } else {
        return '\nğŸ’€ ã€æ¸¸æˆç»“æŸã€‘ä½ è€—å°½äº†ä½“åŠ›æˆ–ç‰©èµ„ï¼Œæ— æ³•ç»§ç»­æ—…ç¨‹ã€‚è¯·é‡æ–°å¼€å§‹ã€‚';
      }
    }

    let state = `${this.player.getStatus()}`;
    if (this.currentCity) {
      state += `\nğŸ“ å½“å‰ä½ç½®: ${this.currentCity.getRoundInfo()}`;
    }
    
    // æ˜¾ç¤ºåŒå·¥å›¢é˜Ÿ
    if (this.companions.length > 0) {
      state += '\n\nğŸ‘¥ åŒå·¥å›¢é˜Ÿï¼š';
      this.companions.forEach(companion => {
        state += '\n   ' + companion.getStatus();
      });
    }
    
    // æ˜¾ç¤ºä¹¦ä¿¡æ”¶é›†
    state += this.letterSystem.getCollectionStatus();
    
    state += this.getAvailableActions();
    
    return state;
  }

  getAvailableActions(): string {
    let output = '\nğŸ“‹ å¯é€‰è¡ŒåŠ¨:\n';
    const actions: ActionType[] = ['preach', 'tentmaking', 'disciple', 'rest', 'write_letter'];
    
    actions.forEach((key, index) => {
      const action = ACTIONS[key];
      output += `  ${index + 1}. ${action.nameChinese} - ${action.description}\n`;
    });
    
    return output;
  }

  addToLog(message: string): void {
    this.gameLog.push(`[å›åˆ${this.currentTurn}] ${message}`);
  }

  getGameLog(): string[] {
    return this.gameLog;
  }

  getGameState(): {
    player: Player;
    currentCity: City | null;
    turn: number;
    maxTurns: number;
    isGameOver: boolean;
    isVictory: boolean;
    letterCollection: ReturnType<LetterSystem['getCollectionStatus']>;
  } {
    return {
      player: this.player,
      currentCity: this.currentCity,
      turn: this.currentTurn,
      maxTurns: this.maxTurns,
      isGameOver: this.isGameOver,
      isVictory: this.isVictory,
      letterCollection: this.letterSystem.getCollectionStatus(),
    };
  }

  async runDemo(delay: number = 1000): Promise<void> {
    console.log('\nğŸ® å¼€å§‹ä¿ç½—æ—…è¡Œå¸ƒé“æ¸¸æˆæ¼”ç¤º...\n');
    this.initializeGame();
    console.log(this.getGameStateDisplay());

    const actionKeys: ActionType[] = ['preach', 'tentmaking', 'disciple', 'rest'];

    while (!this.gameOver) {
      await this.sleep(delay);
      
      const eventResult = this.triggerEvent();
      if (eventResult.event) {
        if (eventResult.event.type === 'decision') {
          const decisionEvent = eventResult.event as DecisionEvent;
          const randomChoice = Math.floor(Math.random() * decisionEvent.choices.length);
          const decisionResult = this.handleDecision(eventResult.event.id, randomChoice);
          console.log(decisionResult);
        } else {
          console.log(eventResult.message);
        }
        await this.sleep(delay);
      }
      
      // AIç­–ç•¥ï¼šç®€å•å†³ç­–
      const randomAction = actionKeys[Math.floor(Math.random() * actionKeys.length)];
      
      let chosenAction: ActionType;
      if (this.player.stamina < 30) {
        chosenAction = 'rest';
      } else if (this.player.provision < 20) {
        chosenAction = 'tentmaking';
      } else if (this.player.persecution > 60) {
        chosenAction = 'disciple';
      } else {
        chosenAction = randomAction;
      }

      // AIåˆ†é…åŒå·¥ä»»åŠ¡ï¼ˆç®€åŒ–ç‰ˆï¼‰
      const companionActions = new Map<string, CompanionTaskType>();
      this.companions.forEach(companion => {
        if (companion.stamina > 20 && companion.morale >= 40) {
          if (this.player.stability < 40) {
            companionActions.set(companion.id, 'teach');
          } else if (this.player.persecution > 50) {
            companionActions.set(companion.id, 'visitation');
          } else {
            companionActions.set(companion.id, 'logistics');
          }
        } else {
          companionActions.set(companion.id, 'rest');
        }
      });

      const result = this.handleAction(chosenAction, companionActions);
      console.log(result);
    }

    console.log(this.getGameStateDisplay());
    
    if (this.victory) {
      console.log(this.displayEvaluation());
    }
  }

  private sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

// ============================================
// 9. ä¸»å‡½æ•°å’Œå¯¼å‡º
// ============================================

import * as readline from 'readline';

// æ¼”ç¤ºæ¨¡å¼ - è‡ªåŠ¨è¿è¡Œ
async function runDemoMode(): Promise<void> {
  const game = new GameEngine();
  console.log('\nğŸ® å¼€å§‹æ¼”ç¤ºæ¨¡å¼ï¼ˆAIè‡ªåŠ¨æ¸¸ç©ï¼‰...\n');
  await game.runDemo(800);
}

// äº¤äº’æ¨¡å¼ - æ‰‹åŠ¨æ¸¸ç©
async function runInteractiveMode(): Promise<void> {
  const game = new GameEngine();
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  });
  
  const question = (prompt: string): Promise<string> => {
    return new Promise((resolve) => {
      rl.question(prompt, (answer) => resolve(answer));
    });
  };

  console.clear?.();
  console.log('\nğŸ® æ¬¢è¿æ¥åˆ°ã€Šä¿ç½—æ—…è¡Œå¸ƒé“ã€‹v2.0ï¼');
  console.log('\nğŸ†• æ–°ç‰¹æ€§ï¼š');
  console.log('- ğŸ‘¥ åŒå·¥ç³»ç»Ÿï¼šæ‹›å‹ŸåŒå·¥ï¼Œåˆ†é…ä»»åŠ¡ï¼Œå›¢é˜Ÿåä½œ');
  console.log('- âœ‰ï¸ ä¹¦ä¿¡ç³»ç»Ÿï¼šæ’°å†™ä¹¦ä¿¡ï¼Œè·¨è¶Šæ—¶ç©ºæ²»ç†æ•™ä¼š');
  console.log('- ğŸ“š æ”¶é›†è¦ç´ ï¼šå®Œæˆæ–°çº¦ä¹¦ä¿¡å…¨é›†ï¼Œè§£é”éšè—ç»“å±€');
  console.log('\næŒ‰ Enter å¼€å§‹æ¸¸æˆ...');
  await question('');

  // åˆå§‹åŒ–æ¸¸æˆ
  game.initializeGame();
  game.startCity('Antioch');

  while (!game.isGameOver) {
    console.clear?.();
    console.log(game.getGameStateDisplay());
    console.log();
    
    // æ˜¾ç¤ºæ¸¸æˆæ—¥å¿—ï¼ˆæœ€è¿‘5æ¡ï¼‰
    const logs = game.getGameLog().slice(-5);
    if (logs.length > 0) {
      console.log('ğŸ“œ æœ€è¿‘äº‹ä»¶ï¼š');
      logs.forEach(log => console.log('  ' + log));
      console.log();
    }

    // ä¸ºåŒå·¥åˆ†é…ä»»åŠ¡
    const activeCompanions = game.player.companions.filter(c => c.isActive && c.morale >= 20);
    const companionActions = new Map<string, CompanionTaskType>();
    
    if (activeCompanions.length > 0) {
      console.log('ğŸ‘¥ åŒå·¥ä»»åŠ¡åˆ†é…ï¼š');
      for (const companion of activeCompanions) {
        console.log(`\n${companion.nameChinese} (${companion.specialtyName})`);
        console.log(`  ä½“åŠ›: ${companion.stamina}/${companion.maxStamina} | å£«æ°”: ${companion.morale}`);
        console.log('  å¯é€‰ä»»åŠ¡ï¼š');
        console.log('    1. æ•™å¯¼ (+12æ•™ä¼šå¥åº·, -15ä½“åŠ›)');
        console.log('    2. æ¢è®¿ (-8é€¼è¿«, +3å¥åº·, -12ä½“åŠ›)');
        console.log('    3. åå‹¤ (+20ç‰©èµ„, -10ä½“åŠ›)');
        console.log('    4. ååŠ©å†™ä½œ (é™ä½å†™ä¿¡æ¶ˆè€—, -8ä½“åŠ›)');
        console.log('    5. ä¼‘æ¯ (+15ä½“åŠ›)');
        
        let validChoice = false;
        while (!validChoice) {
          const choice = await question(`è¯·é€‰æ‹©${companion.nameChinese}çš„ä»»åŠ¡ (1-5)ï¼š`);
          const taskMap: Record<string, CompanionTaskType> = {
            '1': 'teach',
            '2': 'visitation',
            '3': 'logistics',
            '4': 'assist_writing',
            '5': 'rest',
          };
          if (taskMap[choice.trim()]) {
            companionActions.set(companion.id, taskMap[choice.trim()]);
            validChoice = true;
          } else {
            console.log('âŒ æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥');
          }
        }
      }
    }

    // é€‰æ‹©ä¿ç½—çš„è¡ŒåŠ¨
    console.log('\nğŸ¯ ä¿ç½—çš„è¡ŒåŠ¨ï¼š');
    console.log('  1. å…¬å¼€è®²é“ (+15å¥åº·, +20é€¼è¿«, -20ä½“åŠ›)');
    console.log('  2. ç»‡å¸æ£š (+30ç‰©èµ„, -2å¥åº·, -15ä½“åŠ›)');
    console.log('  3. ç§ä¸‹é—¨è®­ (+5å¥åº·, +2é€¼è¿«, -10ä½“åŠ›)');
    console.log('  4. ä¼‘æ¯ (+20ä½“åŠ›, -10ç‰©èµ„)');
    console.log('  5. æ’°å†™ä¹¦ä¿¡ (-25ä½“åŠ›)');
    console.log('  q. é€€å‡ºæ¸¸æˆ');

    const actionChoice = await question('\nè¯·é€‰æ‹©è¡ŒåŠ¨ (1-5/q)ï¼š');
    
    if (actionChoice.toLowerCase() === 'q') {
      console.log('\nğŸ‘‹ æ„Ÿè°¢æ¸¸ç©ï¼å†è§ï¼');
      rl.close();
      return;
    }

    const actionMap: Record<string, ActionType> = {
      '1': 'preach',
      '2': 'tentmaking',
      '3': 'disciple',
      '4': 'rest',
      '5': 'write_letter',
    };

    const actionType = actionMap[actionChoice.trim()];
    if (!actionType) {
      console.log('âŒ æ— æ•ˆé€‰æ‹©');
      await question('\næŒ‰ Enter ç»§ç»­...');
      continue;
    }

    // æ‰§è¡Œè¡ŒåŠ¨
    const result = game.handleAction(actionType, companionActions);
    console.log('\n' + result);

    // æ£€æŸ¥äº‹ä»¶
    const eventResult = game.triggerEvent();
    if (eventResult.event) {
      if (eventResult.event.type === 'decision') {
        const decisionEvent = eventResult.event as DecisionEvent;
        console.log('\n' + '='.repeat(50));
        console.log(`ğŸ“œ ${decisionEvent.name}`);
        console.log(decisionEvent.text);
        console.log('='.repeat(50));
        decisionEvent.choices.forEach((choice, index) => {
          console.log(`  ${index + 1}. ${choice.label}`);
          console.log(`     ${choice.description}`);
        });
        
        let validDecision = false;
        while (!validDecision) {
          const decisionChoice = await question('\nè¯·é€‰æ‹© (1-2)ï¼š');
          const choiceIndex = parseInt(decisionChoice.trim()) - 1;
          if (choiceIndex === 0 || choiceIndex === 1) {
            const decisionResult = game.handleDecision(decisionEvent.id, choiceIndex);
            console.log(decisionResult);
            validDecision = true;
          } else {
            console.log('âŒ æ— æ•ˆé€‰æ‹©');
          }
        }
      } else {
        console.log(eventResult.message);
      }
    }

    await question('\næŒ‰ Enter ç»§ç»­...');
  }

  // æ¸¸æˆç»“æŸ
  console.clear?.();
  console.log(game.getGameStateDisplay());
  
  if (game.isVictory) {
    console.log('\nğŸŠ æ­å–œå®Œæˆå®£æ•™ä½¿å‘½ï¼');
    console.log(game.displayEvaluation());
  } else {
    console.log('\nğŸ’€ æ¸¸æˆç»“æŸ');
  }
  
  await question('\næŒ‰ Enter é€€å‡º...');
  rl.close();
}

// ä¸»å‡½æ•°
async function main(): Promise<void> {
  // æ£€æµ‹å‘½ä»¤è¡Œå‚æ•°
  const args = process.argv.slice(2);
  
  if (args.includes('--demo')) {
    await runDemoMode();
  } else {
    await runInteractiveMode();
  }
}

// å¯¼å‡ºæ‰€æœ‰ç±»å’Œç±»å‹
export {
  // ç±»å‹
  ResourceChange,
  ActionType,
  CompanionTaskType,
  SpecialtyType,
  Action,
  LetterEffect,
  GameEvent,
  DecisionEvent,
  
  // å¸¸é‡
  INITIAL_RESOURCES,
  CITY_CONFIG,
  ACTIONS,
  COMPANION_TASKS,
  
  // äº‹ä»¶
  ANTIOCH_EVENTS,
  PHILIPPI_EVENTS,
  EPHESUS_EVENTS,
  LETTER_EVENTS,
  
  // ç±»
  Companion,
  LetterSystem,
  Player,
  City,
  GameEngine,
  
  // ä¸»å‡½æ•°
  main,
};

// å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶ï¼Œæ‰§è¡Œä¸»å‡½æ•°
if (typeof require !== 'undefined' && require.main === module) {
  main();
}
